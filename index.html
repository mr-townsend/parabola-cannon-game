<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parabola Cannon: Outdoor Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0f172a;
            color: #1e293b;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            inset: 0;
            overscroll-behavior: none;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .input-glow:focus-within {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
        }
        
        .math-font {
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .log-scroll::-webkit-scrollbar { width: 6px; }
        .log-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .log-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        .toggle-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }

        /* Heart Animation */
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .heart-icon { color: #ef4444; display: inline-block; transition: all 0.3s; }
        .heart-lost { color: #94a3b8; transform: scale(0.8); opacity: 0.5; }
    </style>
</head>
<body class="h-full w-full flex bg-slate-900">

    <!-- MODE SELECTION OVERLAY -->
    <div id="modeSelectScreen" class="absolute inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center p-4">
        <div class="max-w-5xl w-full grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-3 text-center mb-4">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-2 tracking-tight">PARABOLA <span class="text-blue-500">CANNON</span></h1>
                <p class="text-slate-400 text-lg">Select Tactical Mode</p>
            </div>
            
            <!-- SOLO -->
            <button onclick="startGame('practice')" class="group relative overflow-hidden rounded-3xl bg-slate-800 border-2 border-slate-700 hover:border-blue-500 transition-all duration-300 p-6 text-left hover:shadow-[0_0_30px_rgba(59,130,246,0.3)]">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><svg class="w-24 h-24 text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                <h2 class="text-2xl font-bold text-white mb-2 group-hover:text-blue-400">Solo Mission</h2>
                <p class="text-slate-400 text-sm mb-6">Target practice. Master coordinate geometry against static targets.</p>
                <span class="inline-block bg-blue-600/20 text-blue-400 font-bold py-2 px-4 rounded-lg group-hover:bg-blue-600 group-hover:text-white transition-colors text-sm">Start Practice</span>
            </button>

            <!-- VS COMPUTER -->
            <button onclick="startGame('computer')" class="group relative overflow-hidden rounded-3xl bg-slate-800 border-2 border-slate-700 hover:border-amber-500 transition-all duration-300 p-6 text-left hover:shadow-[0_0_30px_rgba(245,158,11,0.3)]">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><svg class="w-24 h-24 text-amber-500" fill="currentColor" viewBox="0 0 24 24"><path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7v2H8v2h8v-2h-2v-2h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H3V4h18v12z"/><path d="M10 15l5-3-5-3v6z"/></svg></div>
                <h2 class="text-2xl font-bold text-white mb-2 group-hover:text-amber-400">Vs Computer</h2>
                <p class="text-slate-400 text-sm mb-6">Survival mode. The AI fires back if you miss. You have 3 hearts.</p>
                <span class="inline-block bg-amber-600/20 text-amber-400 font-bold py-2 px-4 rounded-lg group-hover:bg-amber-600 group-hover:text-white transition-colors text-sm">Battle AI</span>
            </button>

            <!-- 1V1 DUEL -->
            <button onclick="startGame('versus')" class="group relative overflow-hidden rounded-3xl bg-slate-800 border-2 border-slate-700 hover:border-red-500 transition-all duration-300 p-6 text-left hover:shadow-[0_0_30px_rgba(239,68,68,0.3)]">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><svg class="w-24 h-24 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M14.5 17c0 1.65-1.35 3-3 3s-3-1.35-3-3 1.35-3 3-3 3 1.35 3 3zm8.5 0c0 1.65-1.35 3-3 3s-3-1.35-3-3 1.35-3 3-3 3 1.35 3 3zm-13-7c0 1.65-1.35 3-3 3s-3-1.35-3-3 1.35-3 3-3 3 1.35 3 3zm13 0c0 1.65-1.35 3-3 3s-3-1.35-3-3 1.35-3 3-3 3 1.35 3 3z"/></svg></div>
                <h2 class="text-2xl font-bold text-white mb-2 group-hover:text-red-400">1v1 Duel</h2>
                <p class="text-slate-400 text-sm mb-6">Hotseat mode. Take turns on same device. First to 5 points.</p>
                <span class="inline-block bg-red-600/20 text-red-400 font-bold py-2 px-4 rounded-lg group-hover:bg-red-600 group-hover:text-white transition-colors text-sm">Start Duel</span>
            </button>
        </div>
    </div>

    <!-- GAME OVER OVERLAY -->
    <div id="gameOverScreen" class="hidden absolute inset-0 z-[70] bg-black/90 flex flex-col items-center justify-center p-4">
        <div class="max-w-md w-full bg-slate-800 p-8 rounded-3xl border-4 text-center transform transition-all" id="winCard">
            <h2 class="text-4xl font-bold text-white mb-2" id="winTitle">GAME OVER</h2>
            <p class="text-xl text-slate-400 mb-8" id="winSub">Player X Wins!</p>
            <button onclick="resetGame()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg text-lg">
                REMATCH
            </button>
            <button onclick="location.reload()" class="mt-4 w-full bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold py-3 rounded-xl transition-all">
                Main Menu
            </button>
        </div>
    </div>

    <!-- MAIN GAME LAYOUT -->
    <div class="flex-grow flex flex-col h-full min-w-0">
        
        <!-- Game Canvas Container -->
        <div class="relative flex-grow bg-slate-900 overflow-hidden">
            <!-- Top HUD -->
            <div class="absolute top-4 left-4 pointer-events-none z-10 flex gap-4">
                <div class="glass-panel px-4 py-2 rounded-xl shadow-lg">
                    <h1 class="text-lg font-bold text-slate-800">PARABOLA CANNON</h1>
                    <p id="modeBadge" class="text-[10px] text-blue-600 font-bold uppercase">Solo Mission</p>
                </div>
                <!-- Turn Indicator -->
                <div id="turnIndicator" class="hidden glass-panel px-4 py-2 rounded-xl shadow-lg border-l-4 border-blue-500 transition-colors">
                    <h2 id="turnText" class="text-lg font-bold text-slate-800">Player 1 Turn</h2>
                </div>
                <!-- Health Display (Computer Mode) -->
                <div id="healthDisplay" class="hidden glass-panel px-4 py-2 rounded-xl shadow-lg flex items-center gap-2">
                    <span class="text-[10px] text-slate-500 font-bold uppercase mr-1">HULL</span>
                    <div id="heartsContainer" class="flex gap-1 text-xl">
                        <span class="heart-icon">‚ô•</span><span class="heart-icon">‚ô•</span><span class="heart-icon">‚ô•</span>
                    </div>
                </div>
            </div>

            <!-- Game Canvas -->
            <canvas id="gameCanvas" class="w-full h-full cursor-crosshair block"></canvas>
            
            <!-- Instructions Overlay -->
            <div id="instructions" class="hidden absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white max-w-lg w-full p-8 rounded-2xl text-center shadow-2xl border border-slate-200">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üìê</div>
                    <h2 id="instrTitle" class="text-3xl font-bold text-slate-800 mb-2">Field Mission</h2>
                    <p id="instrSub" class="text-slate-500 mb-6 text-sm">Apply coordinate geometry to calculate the projectile trajectory.</p>
                    <div id="instrList" class="text-left space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6 text-slate-700 text-sm"></div>
                    <button onclick="document.getElementById('instructions').classList.add('hidden')" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg">Ready</button>
                </div>
            </div>
        </div>

        <!-- BOTTOM CONTROL PANEL -->
        <div id="controlPanel" class="h-32 bg-slate-800 border-t border-slate-700 flex items-center justify-between px-6 z-20 shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.3)] shrink-0 transition-colors duration-500">
            
            <div class="flex items-center gap-6">
                <!-- Cannon Pos -->
                <div class="flex flex-col relative border-r border-slate-600 pr-6 mr-2">
                    <label class="text-[10px] text-blue-400 font-bold uppercase mb-1 ml-1" id="cannonXLabel">Cannon X</label>
                    <div class="flex items-center input-glow bg-slate-900 rounded-lg border-2 border-slate-600 overflow-hidden">
                        <button class="px-2 py-2 text-slate-400 hover:text-white hover:bg-slate-700 active:bg-slate-600 border-r border-slate-600 transition-colors" onclick="stepInput('inputCannonX', -1)">-</button>
                        <input type="number" id="inputCannonX" placeholder="0" value="0" class="w-14 bg-transparent text-center text-lg font-bold text-white placeholder-slate-600 appearance-none border-none outline-none">
                        <button class="px-2 py-2 text-slate-400 hover:text-white hover:bg-slate-700 active:bg-slate-600 border-l border-slate-600 transition-colors" onclick="stepInput('inputCannonX', 1)">+</button>
                    </div>
                </div>

                <!-- STANDARD CONTROLS -->
                <div id="standardControls" class="flex gap-4 items-end">
                    <div class="flex flex-col relative">
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-1 ml-1">Target X</label>
                        <div class="flex items-center input-glow bg-slate-900 rounded-lg border-2 border-slate-600 overflow-hidden">
                            <button class="px-2 py-2 text-slate-400 hover:text-white hover:bg-slate-700 active:bg-slate-600 border-r border-slate-600 transition-colors" onclick="stepInput('inputX', -1)">-</button>
                            <input type="number" id="inputX" placeholder="0" value="0" class="w-16 bg-transparent text-center text-lg font-bold text-white placeholder-slate-600 appearance-none border-none outline-none">
                            <button class="px-2 py-2 text-slate-400 hover:text-white hover:bg-slate-700 active:bg-slate-600 border-l border-slate-600 transition-colors" onclick="stepInput('inputX', 1)">+</button>
                        </div>
                    </div>
                    
                    <div class="flex flex-col relative">
                        <label id="labelY" class="text-[10px] text-slate-400 font-bold uppercase mb-1 ml-1">Peak Height (k)</label>
                        <div class="flex items-center input-glow bg-slate-900 rounded-lg border-2 border-slate-600 overflow-hidden">
                            <button class="px-2 py-2 text-slate-400 hover:text-white hover:bg-slate-700 active:bg-slate-600 border-r border-slate-600 transition-colors" onclick="stepInput('inputY', -1)">-</button>
                            <input type="number" id="inputY" placeholder="0" value="0" class="w-16 bg-transparent text-center text-lg font-bold text-white placeholder-slate-600 appearance-none border-none outline-none">
                            <button class="px-2 py-2 text-slate-400 hover:text-white hover:bg-slate-700 active:bg-slate-600 border-l border-slate-600 transition-colors" onclick="stepInput('inputY', 1)">+</button>
                        </div>
                    </div>
                </div>

                <!-- FORMULA CONTROLS -->
                <div id="formulaControls" class="hidden gap-2 items-center text-slate-300 font-bold text-xl font-mono bg-slate-900/50 p-2 rounded-xl border border-slate-600/50">
                    <span class="text-emerald-400">y =</span>
                    <div class="flex flex-col relative">
                         <label class="text-[8px] text-emerald-400 absolute -top-3 left-1">a</label>
                         <div class="flex items-center input-glow bg-slate-900 rounded-lg border-2 border-slate-600 overflow-hidden">
                            <button class="px-1 py-1 text-slate-400 hover:text-white hover:bg-slate-700 text-xs border-r border-slate-600" onclick="stepInput('inputA', -0.05)">-</button>
                            <input type="number" id="inputA" placeholder="-0.1" class="w-14 bg-transparent text-center text-sm font-bold text-white placeholder-slate-600 appearance-none border-none outline-none">
                            <button class="px-1 py-1 text-slate-400 hover:text-white hover:bg-slate-700 text-xs border-l border-slate-600" onclick="stepInput('inputA', 0.05)">+</button>
                         </div>
                    </div>
                    <span>(x - </span>
                    <div class="flex flex-col relative">
                        <label class="text-[8px] text-emerald-400 absolute -top-3 left-1">h</label>
                        <div class="flex items-center input-glow bg-slate-900 rounded-lg border-2 border-slate-600 overflow-hidden">
                            <button class="px-1 py-1 text-slate-400 hover:text-white hover:bg-slate-700 text-xs border-r border-slate-600" onclick="stepInput('inputH', -1)">-</button>
                            <input type="number" id="inputH" placeholder="0" class="w-12 bg-transparent text-center text-sm font-bold text-white placeholder-slate-600 appearance-none border-none outline-none">
                            <button class="px-1 py-1 text-slate-400 hover:text-white hover:bg-slate-700 text-xs border-l border-slate-600" onclick="stepInput('inputH', 1)">+</button>
                         </div>
                    </div>
                    <span>)¬≤ + </span>
                    <div class="flex flex-col relative">
                        <label class="text-[8px] text-emerald-400 absolute -top-3 left-1">k</label>
                        <div class="flex items-center input-glow bg-slate-900 rounded-lg border-2 border-slate-600 overflow-hidden">
                            <button class="px-1 py-1 text-slate-400 hover:text-white hover:bg-slate-700 text-xs border-r border-slate-600" onclick="stepInput('inputK', -1)">-</button>
                            <input type="number" id="inputK" placeholder="0" class="w-12 bg-transparent text-center text-sm font-bold text-white placeholder-slate-600 appearance-none border-none outline-none">
                            <button class="px-1 py-1 text-slate-400 hover:text-white hover:bg-slate-700 text-xs border-l border-slate-600" onclick="stepInput('inputK', 1)">+</button>
                         </div>
                    </div>
                </div>

                <button id="fireBtn" class="bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-900/50 transition-all transform hover:scale-105 active:scale-95 h-[50px] flex items-center border border-blue-400/30 ml-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    FIRE
                </button>
            </div>

            <!-- Settings Button -->
            <div class="relative flex items-center h-full pl-6 border-l border-slate-600">
                <button id="homeBtn" onclick="location.reload()" class="bg-slate-700 hover:bg-red-600 text-slate-300 p-3 rounded-xl transition-all shadow-lg active:scale-95 mr-2" title="Exit to Menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
                <button id="settingsBtn" class="bg-slate-700 hover:bg-slate-600 text-slate-300 p-3 rounded-xl transition-all shadow-lg active:scale-95 group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:rotate-45 transition-transform"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>

                <!-- Hidden Drawer -->
                <div id="settingsDrawer" class="absolute bottom-[calc(100%+12px)] right-0 bg-slate-800 border border-slate-600 p-5 rounded-xl shadow-2xl flex flex-col gap-4 min-w-[240px] transition-all transform origin-bottom-right scale-0 opacity-0 pointer-events-none z-50">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-700 pb-2">Mission Settings</h3>
                    
                    <label class="flex items-center justify-between cursor-pointer gap-3 group bg-slate-700/50 p-2 rounded-lg" title="Manipulate the equation directly">
                        <span class="text-xs font-bold text-slate-200 uppercase group-hover:text-emerald-400 transition-colors">Formula Mode</span>
                        <input type="checkbox" id="formulaModeToggle" class="w-5 h-5 accent-emerald-500 rounded cursor-pointer toggle-checkbox bg-slate-700 border-slate-500">
                    </label>

                    <div id="standardSettings" class="flex flex-col gap-4">
                        <label class="flex items-center justify-between cursor-pointer gap-3 group" title="Toggle between Target Y and Vertex Height input">
                            <span class="text-xs font-bold text-slate-300 uppercase group-hover:text-amber-400 transition-colors">Manual Peak Mode</span>
                            <input type="checkbox" id="inputModeToggle" class="w-5 h-5 accent-amber-500 rounded cursor-pointer toggle-checkbox bg-slate-700 border-slate-500" checked>
                        </label>
                    </div>

                    <label class="flex items-center justify-between cursor-pointer gap-3 group" title="Target always at Y=0">
                        <span class="text-xs font-bold text-slate-300 uppercase group-hover:text-blue-400 transition-colors">Ground Targets Only</span>
                        <input type="checkbox" id="groundModeToggle" class="w-5 h-5 accent-blue-600 rounded cursor-pointer toggle-checkbox bg-slate-700 border-slate-500">
                    </label>

                    <label class="flex items-center justify-between cursor-pointer gap-3 group" title="Hide/Show Target Coordinates">
                        <span class="text-xs font-bold text-slate-300 uppercase group-hover:text-emerald-400 transition-colors">Show Coordinates</span>
                        <input type="checkbox" id="showCoordsToggle" class="w-5 h-5 accent-emerald-500 rounded cursor-pointer toggle-checkbox bg-slate-700 border-slate-500">
                    </label>
                </div>
            </div>

        </div>
    </div>

    <!-- RIGHT SIDE: Status & Logs -->
    <div class="w-80 h-full bg-slate-900 border-l border-slate-700 flex flex-col p-4 shadow-2xl z-30 shrink-0">
        <div class="bg-slate-800 rounded-xl p-4 mb-4 border border-slate-700">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Mission Stats</h2>
            <div id="statsContent" class="grid grid-cols-2 gap-4"></div>
        </div>
        <div class="bg-slate-800 rounded-xl p-4 mb-4 border border-slate-700">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Trajectory Data</h2>
            <div class="space-y-2">
                <div><p class="text-[10px] text-slate-500 uppercase">Vertex (h, k)</p><p id="vertexDisplay" class="text-lg font-bold text-blue-400 font-mono">--</p></div>
                <div><p class="text-[10px] text-slate-500 uppercase">Equation</p><p id="equationDisplay" class="text-sm font-bold text-emerald-400 math-font tracking-wide">--</p></div>
            </div>
        </div>
        <div class="flex-grow flex flex-col min-h-0">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Mission Log</h2>
            <div id="logContainer" class="bg-slate-950 rounded-xl flex-grow overflow-y-auto p-3 space-y-2 log-scroll font-mono text-xs border border-slate-800">
                <div class="text-slate-600 italic">Select a mode to begin...</div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Parabola Cannon: Outdoor Edition v19
         * Features:
         * - Mode: Practice, 1v1 Duel, Vs Computer (AI)
         * - AI: Fires back if you miss.
         * - Health System: 3 Hearts.
         */

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- ASSETS ---
        const sprites = { blue: new Image(), red: new Image() };
        let spritesLoaded = { blue: false, red: false };

        function generateCannonSprite(colorStr) {
            const size = 64;
            const c = document.createElement('canvas');
            c.width = size; c.height = size;
            const x = c.getContext('2d');
            x.imageSmoothingEnabled = false;
            x.clearRect(0, 0, size, size);
            const p = 4; const cx = 32; const cy = 32;
            
            x.fillStyle = colorStr;
            x.fillRect(cx - 4*p, cy - 1*p, 6*p, 4*p); 
            x.fillRect(cx - 6*p, cy + 1*p, 4*p, 2*p);

            x.fillStyle = '#1e293b'; 
            x.fillRect(cx - 1*p, cy - 3*p, 4*p, 4*p);
            x.fillRect(cx + 2*p, cy - 5*p, 3*p, 3*p);
            x.fillRect(cx + 4*p, cy - 7*p, 2*p, 3*p);
            x.fillStyle = '#475569';
            x.fillRect(cx + 2*p, cy - 5*p, 3*p, 1*p);

            x.fillStyle = '#0f172a';
            x.fillRect(cx - 3*p, cy - 2*p, 6*p, 6*p); 
            x.fillStyle = '#64748b'; 
            x.fillRect(cx - 1*p, cy - 1*p, 2*p, 2*p);
            x.fillStyle = '#fff';
            x.fillRect(cx - 0.5*p, cy - 0.5*p, 1*p, 1*p);

            return c.toDataURL();
        }

        sprites.blue.src = generateCannonSprite('#3b82f6');
        sprites.blue.onload = () => { spritesLoaded.blue = true; };
        sprites.red.src = generateCannonSprite('#ef4444');
        sprites.red.onload = () => { spritesLoaded.red = true; };

        // --- UI ---
        const inputCannonX = document.getElementById('inputCannonX');
        const cannonXLabel = document.getElementById('cannonXLabel');
        const standardControls = document.getElementById('standardControls');
        const formulaControls = document.getElementById('formulaControls');
        const standardSettings = document.getElementById('standardSettings');
        const controlPanel = document.getElementById('controlPanel');
        
        const inputX = document.getElementById('inputX');
        const inputY = document.getElementById('inputY');
        const labelY = document.getElementById('labelY');
        const inputA = document.getElementById('inputA');
        const inputH = document.getElementById('inputH');
        const inputK = document.getElementById('inputK');

        const fireBtn = document.getElementById('fireBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDrawer = document.getElementById('settingsDrawer');
        const statsContent = document.getElementById('statsContent');
        const vertexDisplay = document.getElementById('vertexDisplay');
        const equationDisplay = document.getElementById('equationDisplay');
        const logContainer = document.getElementById('logContainer');
        const turnIndicator = document.getElementById('turnIndicator');
        const turnText = document.getElementById('turnText');
        const modeBadge = document.getElementById('modeBadge');
        const healthDisplay = document.getElementById('healthDisplay');
        const heartsContainer = document.getElementById('heartsContainer');
        
        const groundModeToggle = document.getElementById('groundModeToggle');
        const inputModeToggle = document.getElementById('inputModeToggle');
        const showCoordsToggle = document.getElementById('showCoordsToggle');
        const formulaModeToggle = document.getElementById('formulaModeToggle');
        
        const gameOverScreen = document.getElementById('gameOverScreen');
        const winCard = document.getElementById('winCard');
        const winTitle = document.getElementById('winTitle');
        const winSub = document.getElementById('winSub');

        // --- STATE ---
        let gameState = {
            mode: null, // 'practice', 'versus', 'computer'
            turn: 1, 
            width: 0, height: 0, originX: 0, originY: 0, gridSize: 40,
            p1: { x: -10, score: 0 },
            p2: { x: 10, score: 0 },
            health: 3, // Player health in computer mode
            practiceTarget: { x: 0, y: 0 },
            practiceScore: 0,
            practiceStreak: 0,
            projectiles: [],
            craters: [], 
            isFiring: false,
            cannonX: 0,
            gameOver: false
        };

        const CONSTANTS = { BARRIER_LIMIT: 4, WIN_SCORE: 5 };
        const COLORS = {
            skyTop: '#60a5fa', skyBottom: '#bfdbfe', ground: '#4ade80', groundDark: '#22c55e', 
            grid: 'rgba(255,255,255,0.4)', axis: 'rgba(0,0,0,0.6)', text: 'rgba(0,0,0,0.5)',
            player1: '#3b82f6', player2: '#ef4444', projectile: '#111827', barrier: 'rgba(255, 0, 0, 0.1)', barrierLine: 'rgba(255, 0, 0, 0.4)'
        };

        // --- INPUT STEPPER ---
        window.stepInput = function(id, step) {
            const input = document.getElementById(id);
            let val = parseFloat(input.value) || 0;
            val += step;
            if (step % 1 !== 0) val = Math.round(val * 10) / 10;
            input.value = val;
            input.dispatchEvent(new Event('input'));
        };

        // --- INIT ---
        function startGame(mode) {
            gameState.mode = mode;
            gameState.gameOver = false;
            document.getElementById('modeSelectScreen').style.display = 'none';
            document.getElementById('instructions').classList.remove('hidden');
            gameOverScreen.classList.add('hidden');
            healthDisplay.classList.add('hidden');
            turnIndicator.classList.add('hidden');

            const instrList = document.getElementById('instrList');
            instrList.innerHTML = ''; 

            if (mode === 'practice') {
                setupMode("Solo Mission", "text-blue-600");
                gameState.p1.x = 0; inputCannonX.value = 0;
                instrList.innerHTML = `<p>1. Set <b>Cannon X</b> to move.</p><p>2. Find <b>Target</b> coordinates.</p><p>3. Input values or Formula.</p><p>4. Fire!</p>`;
                spawnPracticeTarget();
            } else if (mode === 'versus') {
                setupMode("1v1 Duel", "text-red-600");
                gameState.p1.x = -12; gameState.p1.score = 0;
                gameState.p2.x = 12; gameState.p2.score = 0;
                instrList.innerHTML = `<p>1. <b>Player 1 (Blue)</b> goes first.</p><p>2. Aim at <b>Player 2 (Red)</b>.</p><p>3. First to 5 points wins!</p>`;
                startTurn(1);
            } else if (mode === 'computer') {
                setupMode("Vs Computer", "text-amber-500");
                gameState.p1.x = -10; gameState.p2.x = 12; // Static enemy pos
                gameState.p1.score = 0; gameState.health = 3;
                healthDisplay.classList.remove('hidden');
                updateHealthUI();
                instrList.innerHTML = `<p>1. Destroy the <b>Red Enemy</b>.</p><p>2. If you miss, the AI <b>fires back</b>.</p><p>3. You have <b>3 Hearts</b>.</p><p>4. Move your cannon to dodge!</p>`;
                startTurn(1);
            }
            initCanvas();
            updateStatsUI();
        }

        function setupMode(name, colorClass) {
            modeBadge.textContent = name;
            modeBadge.className = `text-[10px] font-bold uppercase ${colorClass}`;
        }

        function resetGame() {
            gameState.p1.score = 0; gameState.p2.score = 0;
            gameState.practiceScore = 0; gameState.practiceStreak = 0;
            gameState.craters = [];
            gameState.projectiles = [];
            gameState.gameOver = false;
            gameOverScreen.classList.add('hidden');
            startGame(gameState.mode);
        }

        function initCanvas() {
            window.addEventListener('resize', resize);
            resize();
            gameLoop();
            setTimeout(() => inputX.focus(), 100);
            updateUIModes();
        }

        function resize() {
            const container = canvas.parentElement;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = container.clientWidth * dpr;
            canvas.height = container.clientHeight * dpr;
            ctx.scale(dpr, dpr);
            
            gameState.width = container.clientWidth;
            gameState.height = container.clientHeight;
            gameState.originX = Math.floor(gameState.width * 0.5); 
            gameState.originY = Math.floor(gameState.height * 0.82); 
            gameState.gridSize = Math.max(Math.floor(gameState.width / 40), 20);
            ctx.imageSmoothingEnabled = false; 
        }

        function startTurn(playerNum) {
            gameState.turn = playerNum;
            const isP1 = playerNum === 1;
            
            // UI
            if (gameState.mode !== 'practice') {
                turnIndicator.classList.remove('hidden');
                turnIndicator.className = `glass-panel px-4 py-2 rounded-xl shadow-lg border-l-4 transition-colors ${isP1 ? 'border-blue-500' : 'border-red-500'}`;
                turnText.textContent = isP1 ? "Player 1 Turn" : (gameState.mode === 'computer' ? "Enemy Turn" : "Player 2 Turn");
                turnText.className = `text-lg font-bold ${isP1 ? 'text-blue-700' : 'text-red-700'}`;
                controlPanel.className = `h-32 border-t flex items-center justify-between px-6 z-20 shadow-[0_-4px_15px_-3px_rgba(0,0,0,0.3)] shrink-0 transition-colors duration-500 ${isP1 ? 'bg-slate-800 border-slate-700' : 'bg-red-900/20 border-red-900/50'}`;
            }

            // Controls
            if (isP1) {
                inputCannonX.value = gameState.p1.x;
                inputX.value = ''; inputY.value = ''; inputA.value = ''; inputH.value = ''; inputK.value = '';
                fireBtn.disabled = false;
                fireBtn.innerText = "FIRE";
                logEvent(`Round Start: Player 1`, 'info');
            } else {
                // Enemy Turn
                fireBtn.disabled = true;
                if (gameState.mode === 'computer') {
                    fireBtn.innerText = "AI TARGETING...";
                    logEvent("Enemy targeting...", "warning");
                    setTimeout(computerTurn, 1500);
                } else {
                    inputCannonX.value = gameState.p2.x;
                    logEvent(`Round Start: Player 2`, 'info');
                }
            }
            
            updateStatsUI();
        }

        function computerTurn() {
            if(gameState.gameOver) return;

            // AI Math: Calculate parabola from p2 to p1 with variance
            const p1 = gameState.p1.x;
            const p2 = gameState.p2.x;
            const variance = (Math.random() - 0.5) * 4; // +/- 2 units error
            const targetX = p1 + variance;
            const startX = p2;
            
            // Parabola Logic
            const h = (startX + targetX) / 2;
            const dist = Math.abs(startX - targetX);
            const k = dist / 2 + 5; // Standard high arc
            
            // a = -k / (startX - h)^2 (assuming start Y=0)
            const a = -k / Math.pow(startX - h, 2);

            logEvent("Enemy Fired!", "warning");
            
            // Visual equation log
            equationDisplay.innerHTML = `AI: y = ${a.toFixed(2)}(x - ${h.toFixed(1)})¬≤ + ${k.toFixed(1)}`;

            gameState.isFiring = true;
            gameState.projectiles.push({
                cx: startX, cy: 0, vx: (h > startX ? 0.15 : -0.15),
                a: a, h: h, k: k,
                owner: 2, trail: []
            });
        }

        function updateStatsUI() {
            if (gameState.mode === 'practice') {
                statsContent.innerHTML = `<div><p class="text-[10px] text-slate-500 uppercase">Score</p><p class="text-2xl font-bold text-emerald-400">${gameState.practiceScore}</p></div><div><p class="text-[10px] text-slate-500 uppercase">Streak</p><p class="text-2xl font-bold text-amber-400">${gameState.practiceStreak}</p></div>`;
            } else if (gameState.mode === 'versus') {
                statsContent.innerHTML = `<div><p class="text-[10px] text-blue-500 uppercase">P1 Score</p><p class="text-2xl font-bold text-blue-400">${gameState.p1.score}</p></div><div><p class="text-[10px] text-red-500 uppercase">P2 Score</p><p class="text-2xl font-bold text-red-400">${gameState.p2.score}</p></div>`;
            } else {
                // Computer
                statsContent.innerHTML = `<div><p class="text-[10px] text-blue-500 uppercase">Hits</p><p class="text-2xl font-bold text-blue-400">${gameState.p1.score}</p></div><div><p class="text-[10px] text-slate-500 uppercase">Mode</p><p class="text-lg font-bold text-amber-400">SURVIVAL</p></div>`;
            }
        }

        function updateHealthUI() {
            heartsContainer.innerHTML = '';
            for(let i=0; i<3; i++) {
                const s = document.createElement('span');
                s.className = 'heart-icon ' + (i >= gameState.health ? 'heart-lost' : '');
                s.innerText = '‚ô•';
                heartsContainer.appendChild(s);
            }
        }

        function logEvent(msg) {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            div.className = 'text-slate-300';
            logContainer.prepend(div);
        }

        // --- MATH HELPERS ---
        function toScreen(x, y) {
            return {
                x: gameState.originX + (x * gameState.gridSize),
                y: gameState.originY - (y * gameState.gridSize)
            };
        }

        function spawnPracticeTarget() {
            const rangeX = Math.floor((gameState.width/2)/gameState.gridSize) - 2;
            const rangeY = Math.floor((gameState.originY)/gameState.gridSize) - 3;
            let nx = Math.floor(Math.random()*rangeX*2) - rangeX;
            if(Math.abs(nx) < 3) nx = 5;
            let ny = groundModeToggle.checked ? 0 : Math.floor(Math.random()*rangeY);
            gameState.practiceTarget = {x: nx, y: ny};
            logEvent(`Target at (${nx}, ${ny})`);
        }

        function updateUIModes() {
            if (formulaModeToggle.checked) {
                standardControls.classList.add('hidden'); standardSettings.classList.add('hidden');
                formulaControls.classList.remove('hidden'); formulaControls.classList.add('flex');
            } else {
                standardControls.classList.remove('hidden'); standardSettings.classList.remove('hidden');
                formulaControls.classList.add('hidden'); formulaControls.classList.remove('flex');
            }
            if (inputModeToggle.checked) {
                labelY.innerText = "Peak Height (k)"; inputY.placeholder = "Peak";
            } else {
                labelY.innerText = "Target Y"; inputY.placeholder = "End Y";
            }
        }

        // --- GAME LOOP ---
        function draw() {
            const grad = ctx.createLinearGradient(0, 0, 0, gameState.height);
            grad.addColorStop(0, COLORS.skyTop); grad.addColorStop(0.7, COLORS.skyBottom);
            grad.addColorStop(0.7, COLORS.ground); grad.addColorStop(1, COLORS.groundDark);
            ctx.fillStyle = grad; ctx.fillRect(0, 0, gameState.width, gameState.height);

            // Grid
            ctx.beginPath(); ctx.strokeStyle = COLORS.grid; ctx.lineWidth = 1;
            const xSteps = Math.ceil(gameState.width / gameState.gridSize / 2);
            for(let i = -xSteps; i <= xSteps; i++) {
                const x = gameState.originX + (i * gameState.gridSize);
                ctx.moveTo(x, 0); ctx.lineTo(x, gameState.height);
                if(i !== 0 && i % 2 === 0) { ctx.fillStyle = COLORS.text; ctx.font = "10px JetBrains Mono"; ctx.fillText(i, x + 2, gameState.originY + 12); }
            }
            const ySteps = Math.ceil(gameState.height / gameState.gridSize);
            for(let i = -2; i <= ySteps; i++) {
                const y = gameState.originY - (i * gameState.gridSize);
                ctx.moveTo(0, y); ctx.lineTo(gameState.width, y);
                if(i !== 0 && i > 0 && i % 2 === 0) { ctx.fillStyle = COLORS.text; ctx.fillText(i, gameState.originX + 4, y - 2); }
            }
            ctx.stroke();

            ctx.beginPath(); ctx.strokeStyle = COLORS.axis; ctx.lineWidth = 2;
            ctx.moveTo(gameState.originX, 0); ctx.lineTo(gameState.originX, gameState.height);
            ctx.moveTo(0, gameState.originY); ctx.lineTo(gameState.width, gameState.originY);
            ctx.stroke();

            // Barrier
            if(gameState.mode === 'versus') {
                const barrierX = gameState.originX; 
                ctx.fillStyle = COLORS.barrier;
                ctx.fillRect(barrierX - (CONSTANTS.BARRIER_LIMIT * gameState.gridSize), 0, (CONSTANTS.BARRIER_LIMIT * 2 * gameState.gridSize), gameState.height);
                ctx.strokeStyle = COLORS.barrierLine; ctx.setLineDash([5, 5]); ctx.beginPath();
                const bx1 = gameState.originX - (CONSTANTS.BARRIER_LIMIT * gameState.gridSize);
                const bx2 = gameState.originX + (CONSTANTS.BARRIER_LIMIT * gameState.gridSize);
                ctx.moveTo(bx1, 0); ctx.lineTo(bx1, gameState.height); ctx.moveTo(bx2, 0); ctx.lineTo(bx2, gameState.height);
                ctx.stroke(); ctx.setLineDash([]);
            }

            drawEntities();
            drawProjectiles();
        }

        function drawEntities() {
            const scale = gameState.gridSize / 32; 
            // Cannons
            if(gameState.mode !== 'practice') {
                if(spritesLoaded.blue) {
                    const pos = toScreen(gameState.p1.x, 0);
                    ctx.drawImage(sprites.blue, pos.x - 32*scale, pos.y - 48*scale, 64*scale, 64*scale);
                }
                if(spritesLoaded.red) {
                    const pos = toScreen(gameState.p2.x, 0);
                    ctx.save(); ctx.translate(pos.x, pos.y); ctx.scale(-1, 1);
                    ctx.drawImage(sprites.red, -32*scale, -48*scale, 64*scale, 64*scale);
                    ctx.restore();
                }
            } else {
                if(spritesLoaded.blue) {
                    const pos = toScreen(gameState.p1.x, 0);
                    ctx.drawImage(sprites.blue, pos.x - 32*scale, pos.y - 48*scale, 64*scale, 64*scale);
                }
                const tPos = toScreen(gameState.practiceTarget.x, gameState.practiceTarget.y);
                ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(tPos.x, tPos.y, 8*scale, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(tPos.x, tPos.y, 5*scale, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(tPos.x, tPos.y, 2*scale, 0, Math.PI*2); ctx.fill();
                if(showCoordsToggle.checked) {
                    ctx.fillStyle = "#fff"; ctx.font = "bold 12px sans-serif";
                    ctx.fillText(`(${gameState.practiceTarget.x}, ${gameState.practiceTarget.y})`, tPos.x, tPos.y - 20);
                }
            }

            // Craters
            gameState.craters.forEach(c => {
                const p = toScreen(c.x, c.y);
                ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(p.x, p.y, 10, 3, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = "10px monospace"; ctx.fillText("X", p.x-3, p.y+3);
            });
        }

        function drawProjectiles() {
            gameState.projectiles.forEach(p => {
                const pos = toScreen(p.cx, p.cy);
                ctx.fillStyle = COLORS.projectile;
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 5, 0, Math.PI*2); ctx.fill();
                if (p.trail && p.trail.length > 0) {
                    ctx.beginPath(); ctx.strokeStyle = p.owner === 2 ? '#ef4444' : 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2;
                    p.trail.forEach((pt, i) => { const s = toScreen(pt.x, pt.y); if(i===0) ctx.moveTo(s.x, s.y); else ctx.lineTo(s.x, s.y); });
                    ctx.stroke();
                }
            });
        }

        function update() {
            for(let i=gameState.projectiles.length-1; i>=0; i--) {
                let p = gameState.projectiles[i];
                p.cx += p.vx;
                p.cy = p.a * Math.pow(p.cx - p.h, 2) + p.k;
                p.trail.push({x: p.cx, y: p.cy});

                // Ground Collision
                if(p.cy < -0.5) { hit(p.cx, 0, p); gameState.projectiles.splice(i, 1); continue; }
                
                // Entity Collision
                if(gameState.mode === 'practice') {
                     const dx = p.cx - gameState.practiceTarget.x;
                     const dy = p.cy - gameState.practiceTarget.y;
                     if(Math.sqrt(dx*dx + dy*dy) < 0.8) { hit(p.cx, p.cy, p, true); gameState.projectiles.splice(i, 1); continue; }
                } else {
                    // Check collision with opponent
                    const enemyX = (p.owner === 1) ? gameState.p2.x : gameState.p1.x;
                    const dx = p.cx - enemyX;
                    const dy = p.cy - 0;
                    if(Math.sqrt(dx*dx + dy*dy) < 1.0) { hit(p.cx, 0, p, true); gameState.projectiles.splice(i, 1); continue; }
                }
                
                if(Math.abs(p.cx) > 50 || p.cy < -50) gameState.projectiles.splice(i, 1);
            }
        }

        function hit(x, y, p, directHit = false) {
            if(directHit) {
                if(gameState.mode === 'practice') {
                    gameState.practiceScore += 100 + (gameState.practiceStreak*10);
                    gameState.practiceStreak++;
                    logEvent("Target Hit!");
                    spawnPracticeTarget();
                } else if(gameState.mode === 'versus') {
                    if(p.owner === 1) gameState.p1.score++; else gameState.p2.score++;
                    logEvent(`Player ${p.owner} Scored!`);
                    if(gameState.p1.score >= CONSTANTS.WIN_SCORE || gameState.p2.score >= CONSTANTS.WIN_SCORE) endGame(p.owner);
                    else startTurn(p.owner === 1 ? 2 : 1);
                } else if(gameState.mode === 'computer') {
                    if(p.owner === 1) {
                        gameState.p1.score++; // Player hit AI
                        logEvent("Direct Hit on Enemy!");
                        startTurn(1); // Player gets to go again or reset? Let's reset
                    } else {
                        // AI hit Player
                        gameState.health--;
                        updateHealthUI();
                        logEvent("HULL DAMAGE DETECTED!");
                        if(gameState.health <= 0) endGame("COMPUTER");
                        else startTurn(1);
                    }
                }
                gameState.craters = [];
            } else {
                // Miss
                gameState.craters.push({x: x, y: y});
                if(gameState.mode === 'practice') {
                     gameState.practiceStreak = 0;
                     logEvent(`Miss at (${x.toFixed(1)}, ${y.toFixed(1)})`);
                } else {
                     logEvent(`Miss.`);
                     // Switch turn logic
                     if(gameState.mode === 'computer' && p.owner === 1) {
                         startTurn(2); // AI Turn
                     } else if (gameState.mode === 'computer' && p.owner === 2) {
                         startTurn(1); // AI Missed, Player Turn
                     } else {
                         startTurn(p.owner === 1 ? 2 : 1); // Versus swap
                     }
                }
            }
            gameState.isFiring = false;
            fireBtn.disabled = false;
            updateStatsUI();
        }

        function endGame(winner) {
            gameState.gameOver = true;
            gameOverScreen.classList.remove('hidden');
            winTitle.textContent = winner === "COMPUTER" ? "DEFEAT" : "VICTORY";
            winSub.textContent = winner === "COMPUTER" ? "Mission Failed" : `Player ${winner} Wins!`;
        }

        function fire() {
            if(gameState.isFiring) return;
            
            let a, h, k;
            const startX = parseFloat(inputCannonX.value);
            
            if(formulaModeToggle.checked) {
                a = parseFloat(inputA.value) || 0; h = parseFloat(inputH.value) || 0; k = parseFloat(inputK.value) || 0;
            } else {
                const tx = parseFloat(inputX.value) || 0;
                const ty = parseFloat(inputY.value) || 0;
                
                if(inputModeToggle.checked) {
                    h = (startX + tx) / 2; k = ty;
                    if(Math.abs(startX - h) < 0.001) h += 0.1;
                    a = -k / Math.pow(startX - h, 2);
                } else {
                     const dist = Math.abs(tx - startX);
                     h = (startX + tx) / 2; k = Math.max(0, ty) + dist/2 + 2;
                     a = -k / Math.pow(startX - h, 2);
                }
            }

            gameState.isFiring = true;
            fireBtn.disabled = true;

            equationDisplay.innerHTML = `y = ${a.toFixed(3)}(x - ${h.toFixed(1)})¬≤ + ${k.toFixed(1)}`;
            vertexDisplay.innerText = `(${h.toFixed(1)}, ${k.toFixed(1)})`;

            const dir = (h > startX) ? 1 : -1; 
            gameState.projectiles.push({
                cx: startX, cy: 0, vx: 0.15 * dir,
                a: a, h: h, k: k,
                owner: gameState.turn, trail: []
            });
        }

        function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }

        fireBtn.addEventListener('click', fire);
        settingsBtn.addEventListener('click', (e) => {
             e.stopPropagation();
             settingsDrawer.classList.toggle('scale-0'); settingsDrawer.classList.toggle('opacity-0');
             settingsDrawer.classList.toggle('pointer-events-none');
        });
        
        inputModeToggle.addEventListener('change', updateUIModes);
        formulaModeToggle.addEventListener('change', updateUIModes);
        groundModeToggle.addEventListener('change', () => { if(gameState.mode === 'practice') spawnPracticeTarget(); });
        
        inputCannonX.addEventListener('input', (e) => {
             if(gameState.mode === 'versus') {
                 const v = parseFloat(e.target.value);
                 const limit = CONSTANTS.BARRIER_LIMIT;
                 if(gameState.turn === 1 && v > -limit) e.target.value = -limit;
                 if(gameState.turn === 2 && v < limit) e.target.value = limit;
                 if(gameState.turn === 1) gameState.p1.x = parseFloat(e.target.value); else gameState.p2.x = parseFloat(e.target.value);
             } else {
                 gameState.p1.x = parseFloat(e.target.value);
             }
        });

    </script>
</body>
</html>
